<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TF2 course</title>
  <style>
    body { margin: 0; font-family: monospace; }
    #ui {
      position: absolute; top: 10px; left: 10px;
      background: rgba(255,255,255,0.9); padding: 10px;
      padding-left: 40px;
      padding-right: 40px;
      border-radius: 8px; font-size: 14px;
    }
    input { width: 80px; }
    pre { font-size: 12px; }
    .viz { width: 400px; height: 300px; border: 1px solid #ccc; margin: 20px 0; }

    .container-input {
        display: flex;
        flex-direction: row;
        align-items: center;
    }

    .container-input > input {
        margin-right: 1rem;
    }

    .controls {
        display: flex;
        flex-direction: row;
    }

    .status {
        color: #08d700;
        font-size: 1.5rem;
    }
  </style>
</head>
<body>
<div id="ui">
  <h1>Rigid Body Transforms</h1>
  <p>
    A rigid body transformation is a linear 3D transformation consisting of:
    <ul>
        <li>A translation (a <b>change in position</b>)</li>
        <li>A rotation (a <b>change in orientation</b>)</li>
    </ul>

    Note that a rigid body transformation can not stretch, bend nor flip an object. It is most useful for 
    describing relative locations and poses.
  </p>

  <p>
    Describing a rigid body transformation can thus be done by using 6 numbers:
    <ul>
        <li>Change in <b>x</b></li>
        <li>Change in <b>y</b></li>
        <li>Change in <b>z</b></li>
        <li>Rotation around x</li>
        <li>Rotation around y</li>
        <li>Rotation around z</li>
    </ul>

    <!-- TODO: SO(3) mention -->
    <!-- TODO: footnote about body frame conventions -->

    This way of describing rotations is called <i>Euler angles</i>, and is the method used in tools like <a href="https://wiki.ros.org/tf2">tf2</a>.

    Euler angles are simple to understand and visualize, but suffer from some problems that make them sub optimal to use in computations. Internally,
    TF2 and other software therefore typically use <a href="https://en.wikipedia.org/wiki/Quaternion">quaternions</a>. But you don't have to worry too 
    much about that (yet).
  </p>

  <h3>Conventions</h3>
  <p>
  In this course we use some conventions. I've tried to align them with the conventions used in ROS2.
  <ul>
      <li>The first axis (x-axis) is colored <span style="color: red"><b>red</b></span></li>
      <li>The second axis (y-axis) is colored <span style="color: #08e700"><b>green</b></span></li>
      <li>The third axis (z-axis) is colored <span style="color: blue"><b>blue</b></span></li>
      <li>All translations <b>and rotations</b> are described in the <b>parent frame</b>, i.e. the frame we transform <i>from</i>. 
          This is called extrinsic rotations or Euler 'ZYX' order. 
          Read more <a href="https://mecademic.com/insights/academic-tutorials/space-orientation-euler-angles/">here</a>.</li>
      <li>Rotation around the x-axis is referred to as <b>roll</b></li>
      <li>Rotation around the y-axis is referred to as <b>pitch</b></li>
      <li>Rotation around the z-axis is referred to as <b>yaw</b></li>
      <li>For simplicity, the input elements for the rotations in this course are defined in <b>degrees</b>. Before computations they are of course translated to radians.</li>
  </ul>
  </p>

  <h3>Controls</h3>
  <p>
    In each visualization, you can control the camera view.
    <ul>
        <li>To rotate the view, hold left click and drag with the mouse</li>
        <li>To translate the view, hold right click, shift or ctrl and drag with the mouse</li>
        <li>To zoom, scroll using the mouse(pad)</li>
    </ul>
  </p>

  <p>
    Before we continue, you can get a feeling for transformations in the interactive visualization below.
  </p>

  <div>
      <div id="viz1" class="viz"></div>
      <pre class="ros2cmd">ros2 run tf2_ros static_transform_publisher --frame-id parent --child-frame-id child</pre>
      <div class="controls">
          <div class="container-input">
              x: <input type="range" class="tx" min="-5" max="5" step="0.1" value="0">
          </div>
          <div class="container-input">
              y: <input type="range" class="ty" min="-5" max="5" step="0.1" value="0">
          </div>
          <div class="container-input">
              z: <input type="range" class="tz" min="-5" max="5" step="0.1" value="0">
          </div>
          <div class="container-input">
              roll: <input type="range" class="rx" min="0" max="360" step="1" value="0">
          </div>
          <div class="container-input">
              pitch: <input type="range" class="ry" min="0" max="360" step="1" value="0">
          </div>
          <div class="container-input">
              yaw: <input type="range" class="rz" min="0" max="360" step="1" value="0">
          </div>
          <div class="container-input">
              <input type="button" class="reset" value="reset"></input>
          </div>
      </div>
      <pre class="matrix"></pre>
  </div>

  <h2>Tasks</h2>
  <p>
    What follows are some tasks I have prepared to force you to become familiar with using transforms.
  </p>

  <h3>Task 1 - Static translation</h3>

  <p>
    We have arrived at the testing site and placed our Ground Control Station. The drone will launch from a launch pad placed on the runway.
    We are going to perform some measurements from the drone and the GCS simultaneously, so it would be helpful to be able to convert coordinates relative 
    to the drone to coordinates relative to the GCS. When the drone is started, it places its origin on the launch pad, and coordinates measured from the 
    drone will be relative to the launch pad.
  </p>

  <p>
  We have estimated the launch pad to be <b>5m</b> in the x-direction, <b>2m</b> in the y-direction and <b>-1m</b> in the z-direction relative to the GCS.
  </p>

  <p>
  Please provide the transformation <b>gcs -> launch_pad</b>.
  </p>
  <div>
      <div id="viz2" class="viz"></div>
      <pre class="ros2cmd">ros2 run tf2_ros static_transform_publisher --frame-id gcs --child-frame-id launch_pad</pre>
      <div class="controls">
          <div class="container-input">
              x: <input type="number" class="tx" value="0">
          </div>
          <div class="container-input">
              y: <input type="number" class="ty" value="0">
          </div>
          <div class="container-input">
              z: <input type="number" class="tz" value="0">
          </div>
          <div class="container-input">
              <input type="hidden" class="rx" value="0">
          </div>
          <div class="container-input">
              <input type="hidden" class="ry" value="0">
          </div>
          <div class="container-input">
              <input type="hidden" class="rz" value="0">
          </div>
          <div class="container-input">
              <input type="button" class="reset" value="reset"></input>
          </div>

      </div>
      <br>
      <div class="status"></div>
  </div>

  <h3>Task 2 - Static translation and rotation</h3>

  <p>
      When transforming the measurements from the drone, you notice by inspection that they are <i>way off!</i>
      This is weird, you even verified the location using <a href="https://docs.ros.org/en/rolling/Tutorials/Intermediate/RViz/RViz-User-Guide/RViz-User-Guide.html">rviz2</a>.

      A helpful Control member inspects the Mavlink messages sent by PX4 in QGroundControl. He notices that the x-axis defined by the drone on startup does not align with the x-axis you have on the GCS at all!
      The drone uses its compass to align the x-axis to the <i>North</i>, while you have placed the GCS facing directly East.
  </p>

  <p>
  The launch pad is still at <b>5m</b> in the x-direction, <b>2m</b> in the y-direction and <b>-1m</b> in the z-direction relative to the GCS.

  <br>

  The x-axis defined by the drone is rotated <b>90Â°</b> with respect to the z-axis of the GCS.
  </p>

  <p>
  Please fix the transformation <b>gcs -> launch_pad</b>.
  </p>

  <div>
      <div id="viz3" class="viz"></div>
      <pre class="ros2cmd">ros2 run tf2_ros static_transform_publisher --frame-id gcs --child-frame-id launch_pad</pre>
      <div class="controls">
          <div class="container-input">
              x: <input type="number" class="tx" value="0">
          </div>
          <div class="container-input">
              y: <input type="number" class="ty" value="0">
          </div>
          <div class="container-input">
              z: <input type="number" class="tz" value="0">
          </div>
          <div class="container-input">
              roll: <input type="number" class="rx" value="0">
          </div>
          <div class="container-input">
              pitch: <input type="number" class="ry" value="0">
          </div>
          <div class="container-input">
              yaw: <input type="number" class="rz" value="0">
          </div>
          <div class="container-input">
              <input type="button" class="reset" value="reset"></input>
          </div>

      </div>
      <br>
      <div class="status"></div>
  </div>

  <h3>Task 3 - Static translation and rotation II</h3>

  <p>
    On the next workday you prepare the drone for testing once again. You notice that some of the transforms you proudly had set up are gone!
    Listening to the <i>All Meeting</i> presentations, you hear Autonomy say something like "<i>we lost the code</i>" or something. Hmm. They probably didn't pay attention during the git course held earlier...
  </p>

  <p>
      Specifically, the sensor you are using is a camera, and the transformation <b>drone_flu -> camera</b> is gone. The coordinate frame attached to the drone's body is currently defined using the 
      <b>FLU</b> - <i>Forward, Left, Up</i> - convention. This means that the x-axis points forward, 
      the y-axis to the left, and the z-axis points up. The camera frame, however, is attached to the <i>optical center</i> of the camera, and the axes are defined as follows:
      <ul>
          <li>When looking through the camera lens, the x-axis points to the <b>right</b></li>
          <li>When looking through the camera lens, the y-axis points <b>down</b></li>
          <li>The z-axis points <b>out</b> of the camera</li>
      </ul>
      Please verify that this coordinate system is right handed.
      <br>
      The camera is mounted such that it points downwards, with the top of the image facing forwards. The camera itself if <b>20 cm</b> in front of, and <b>5 cm</b> down
      relative to the origin of the drone body. Refer to the figure.
  </p>

  <image style="height: 20rem; width: auto;" src="./figure1.png" />

  <p>
  In this task, the center of the "world" in the visualization is the drone's body. Remember that lengths are still in <i>meters</i> and angles in <i>degrees</i>.
  </p>
  <p>
  Please provide the transformation <b>drone_flu -> camera</b>


  <div>
      <div id="viz4" class="viz"></div>
      <pre class="ros2cmd">ros2 run tf2_ros static_transform_publisher --frame-id drone_flu --child-frame-id camera</pre>
      <div class="controls">
          <div class="container-input">
              x: <input type="number" class="tx" value="0">
          </div>
          <div class="container-input">
              y: <input type="number" class="ty" value="0">
          </div>
          <div class="container-input">
              z: <input type="number" class="tz" value="0">
          </div>
          <div class="container-input">
              roll: <input type="number" class="rx" value="0">
          </div>
          <div class="container-input">
              pitch: <input type="number" class="ry" value="0">
          </div>
          <div class="container-input">
              yaw: <input type="number" class="rz" value="0">
          </div>
          <div class="container-input">
              <input type="button" class="reset" value="reset"></input>
          </div>

      </div>
      <br>
      <div class="status"></div>
  </div>

  <h3>Task 4 - Dynamic translation</h3>

  <p>
    Nice, the static transforms are working correctly. But we still havent provided the transform from the launch pad to the drone.
  </p>

  <p>
    It is probably a good idea to do things one at a time, lets start with translation only. The plan is to create a ROS2 node which subscribes to
    the drone position given by the flight controller (PX4) in some way. Our job is to use a TransformBroadcaster to publish the position of the drone
    as a transform from the launch pad to the drone_flu frame.
  </p>

  <p>
    In this task you will complete the C++ snippet below the visualization. Some of the fields require you to put the correct string in the field,
    while the numerical field accepts some kind of expression using the local variables in the snippet. You shouldn't have to write anything too complicated.
    If you are successful, you will see the "Success!" status (as before).
  </p>

  <p>
  Some resources:
  <ul>
      <li><a href="https://docs.ros.org/en/latest/api/tf2_ros/html/c++/namespacetf2__ros.html">tf2_ros documentation</a></li>
      <li><a href="https://docs.ros2.org/latest/api/geometry_msgs/index-msg.html">geometry_msgs documentation</a></li>
  </ul>
  </p>

  <p>
    Please provide the <i>dynamic</i> transform <b>launch_pad -> drone_flu</b>
  </p>

  <div>
      <div id="viz5" class="viz"></div>
      <pre class="ros2cmd"></pre>
      <div class="controls">
          <pre>
// In our beautiful ROS2 node
void position_callback(geometry_msgs::msg::PointStamped::SharedPtr msg) {
    const double pos_x = msg->point.x;
    const double pos_y = msg->point.y;
    const double pos_z = msg->point.z;

    geometry_msgs::msg::TransformStamped t;
    t.header.stamp = this->get_clock()->now();
    t.header.frame_id = "<input type="text" class="frame_id" value="" placeholder="Enter string..">";
    t.child_frame_id = "<input type="text" class="child_frame_id" placeholder="Enter string..">";

    t.<input type="text" class="transform" value="" placeholder="Enter property name">.translation.x = <input type="text" class="tx" value="" placeholder="Enter expression..">;
    t.<input type="text" class="transform" value="" placeholder="Enter property name">.translation.y = <input type="text" class="ty" value="" placeholder="Enter expression..">;
    t.<input type="text" class="transform" value="" placeholder="Enter property name">.translation.z = <input type="text" class="tz" value="" placeholder="Enter expression..">;

    // tf_broadcaster has type tf2_ros::TransformBroadcaster*
    tf_broadcaster-><input type="text" class="tf_broadcaster" style="width: 6rem;"value="" placeholder="Enter function name">(t);
}
          </pre>
          <div class="container-input">
              <input type="hidden" class="rx" value="0">
          </div>
          <div class="container-input">
              <input type="hidden" class="ry" value="0">
          </div>
          <div class="container-input">
              <input type="hidden" class="rz" value="0">
          </div>
      </div>
      <br>
      <div class="status"></div>
  </div>

  <h3>Task 5 - Dynamic translation and rotation</h3>

  <p>
    Nice, almost there. But remember that the drone_flu frame should rotate with the body of the drone as well. Measuring the attitude of the drone is done in 
    the state estimator of the flight controller. Most often this is already described using a quaternion when you receive it, but remember - 
    it might not always be described in the frame you are interested in.
  </p>

  <p>
  We will still simplify a bit and ignore some of the components of the attitude. Specifically you'll receive the <a href="https://en.wikipedia.org/wiki/Heading_(navigation)">heading</a> of the drone, in <b>radians</b>.
  The heading is described relative to <i>north</i> (remember the orientation of the launch pad?).
  </p>

  <p>
  Please fix the transformation <b>launch_pad -> drone_flu</b>.
  </p>

  <div>
      <div id="viz6" class="viz"></div>
      <pre class="ros2cmd"></pre>
      <div class="controls">
          <pre>
// In our beautiful ROS2 node
void pose_callback(geometry_msgs::msg::PointStamped::SharedPtr pos_msg, double heading_rad) {
    const double pos_x = pos_msg->point.x;
    const double pos_y = pos_msg->point.y;
    const double pos_z = pos_msg->point.z;

    geometry_msgs::msg::TransformStamped t;
    t.header.stamp = this->get_clock()->now();
    t.header.frame_id = "<input type="text" class="frame_id" value="" placeholder="Enter string..">";
    t.child_frame_id = "<input type="text" class="child_frame_id" placeholder="Enter string..">";

    t.<input type="text" class="transform" value="" placeholder="Enter property name">.translation.x = <input type="text" class="tx" value="" placeholder="Enter expression..">;
    t.<input type="text" class="transform" value="" placeholder="Enter property name">.translation.y = <input type="text" class="ty" value="" placeholder="Enter expression..">;
    t.<input type="text" class="transform" value="" placeholder="Enter property name">.translation.z = <input type="text" class="tz" value="" placeholder="Enter expression..">;

    tf2::Quaternion tf2_quat;

    tf2_quat.setRPY(
        <input type="text" class="rx" value="" placeholder="Enter expression.." style="width: 7rem;">,
        <input type="text" class="ry" value="" placeholder="Enter expression.." style="width: 7rem;">,
        <input type="text" class="rz" value="" placeholder="Enter expression.." style="width: 7rem;">
    );
    
    t.<input type="text" class="transform" value="" placeholder="Enter property name">.rotation = tf2::toMsg(tf2_quat);

    // tf_broadcaster has type tf2_ros::TransformBroadcaster*
    tf_broadcaster-><input type="text" class="tf_broadcaster" style="width: 6rem;"value="" placeholder="Enter function name">(t);
}
          </pre>
      </div>
      <br>
      <div class="status"></div>
  </div>

  <br>
  <br>
  <br>
  <br>
  <br>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.179.1/examples/jsm/"
  }
}
</script>
<script type="module" src="main.js"></script>
</body>
</html>
